import React, { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight } from 'lucide-react';

export default function StreakCounter() {
  const [streakData, setStreakData] = useState({});
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [currentStreak, setCurrentStreak] = useState(0);
  const [totalDays, setTotalDays] = useState(0);

  // Initialize from localStorage
  useEffect(() => {
    const today = new Date().toISOString().split('T')[0];
    const saved = localStorage.getItem('streakData');
    if (saved) {
      setStreakData(JSON.parse(saved));
    }
    calculateStats();
  }, []);

  // Save to localStorage whenever streakData changes
  useEffect(() => {
    if (Object.keys(streakData).length > 0) {
      localStorage.setItem('streakData', JSON.stringify(streakData));
    }
    calculateStats();
  }, [streakData]);

  const calculateStats = () => {
    const today = new Date();
    let streak = 0;
    let total = Object.keys(streakData).length;

    // Calculate current streak
    for (let i = 0; i < 365; i++) {
      const checkDate = new Date(today);
      checkDate.setDate(checkDate.getDate() - i);
      const dateStr = checkDate.toISOString().split('T')[0];

      if (streakData[dateStr]) {
        streak++;
      } else if (i > 0) {
        break;
      }
    }

    setCurrentStreak(streak);
    setTotalDays(total);
  };

  const toggleDay = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    setStreakData((prev) => {
      const updated = { ...prev };
      if (updated[dateStr]) {
        delete updated[dateStr];
      } else {
        updated[dateStr] = true;
      }
      return updated;
    });
  };

  const getDaysInMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  };

  const getFirstDayOfMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  };

  const isToday = (date) => {
    const today = new Date();
    return (
      date.getDate() === today.getDate() &&
      date.getMonth() === today.getMonth() &&
      date.getFullYear() === today.getFullYear()
    );
  };

  const isCompleted = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    return !!streakData[dateStr];
  };

  const monthName = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
  const daysInMonth = getDaysInMonth(currentMonth);
  const firstDay = getFirstDayOfMonth(currentMonth);

  const calendarDays = [];
  for (let i = 0; i < firstDay; i++) {
    calendarDays.push(null);
  }
  for (let i = 1; i <= daysInMonth; i++) {
    calendarDays.push(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i));
  }

  const previousMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
  };

  const nextMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
  };

  return (
    <div className="w-full h-screen bg-gradient-to-br from-orange-50 via-white to-red-50 flex flex-col overflow-hidden">
      {/* Header - Streak Stats */}
      <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 shadow-lg">
        <h1 className="text-3xl font-bold mb-4">ðŸ”¥ Streak Counter</h1>
        <div className="flex justify-around">
          <div className="text-center">
            <div className="text-4xl font-bold">{currentStreak}</div>
            <div className="text-sm opacity-90">Current Streak</div>
          </div>
          <div className="text-center">
            <div className="text-4xl font-bold">{totalDays}</div>
            <div className="text-sm opacity-90">Total Days</div>
          </div>
        </div>
      </div>

      {/* Calendar Container */}
      <div className="flex-1 overflow-y-auto p-4">
        {/* Month Header */}
        <div className="flex items-center justify-between mb-6">
          <button
            onClick={previousMonth}
            className="p-2 hover:bg-orange-100 rounded-lg transition"
          >
            <ChevronLeft size={24} className="text-orange-600" />
          </button>
          <h2 className="text-xl font-bold text-gray-800">{monthName}</h2>
          <button
            onClick={nextMonth}
            className="p-2 hover:bg-orange-100 rounded-lg transition"
          >
            <ChevronRight size={24} className="text-orange-600" />
          </button>
        </div>

        {/* Day Labels */}
        <div className="grid grid-cols-7 gap-1 mb-2">
          {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day) => (
            <div key={day} className="text-center font-semibold text-gray-600 text-xs py-2">
              {day}
            </div>
          ))}
        </div>

        {/* Calendar Grid */}
        <div className="grid grid-cols-7 gap-1">
          {calendarDays.map((date, index) => {
            if (!date) {
              return <div key={`empty-${index}`} className="aspect-square"></div>;
            }

            const completed = isCompleted(date);
            const today = isToday(date);

            return (
              <button
                key={date.toISOString()}
                onClick={() => toggleDay(date)}
                className={`aspect-square rounded-lg font-bold text-sm transition-all duration-200 flex items-center justify-center ${
                  completed
                    ? 'bg-gradient-to-br from-orange-400 to-red-500 text-white shadow-md hover:shadow-lg'
                    : 'bg-white border-2 border-gray-200 text-gray-700 hover:border-orange-300'
                } ${today ? 'ring-2 ring-offset-2 ring-orange-500' : ''}`}
              >
                <span>{date.getDate()}</span>
              </button>
            );
          })}
        </div>

        {/* Instructions */}
        <div className="mt-8 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
          <p className="text-sm text-gray-700">
            <strong>ðŸ“± How to use:</strong> Tap any day to mark it as completed. Your streak grows by 1 each consecutive day!
          </p>
        </div>
      </div>
    </div>
  );
}